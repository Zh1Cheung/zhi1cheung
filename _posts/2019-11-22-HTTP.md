---
title: HTTP
categories:
- 计算机网络
tags:
- HTTP
---


## HTTP是什么

- HTTP 是什么
  - 超文本传输协议
  - HTTP 是一个在计算机世界里专门在两点之间传输文字、图片、音频、视频等超文本数据的约定和规范
- HTTP 不是什么
  - 因为 HTTP 是一个协议，是一种计算机间通信的规范，所以它不存在“单独的实体”。
  - HTTP 不是一个孤立的协议。
    - 在互联网世界里，HTTP 通常跑在 TCP/IP 协议栈之上，依靠 IP 协议实现寻址和路由、TCP协议实现可靠数据传输、DNS 协议实现域名查找、SSL/TLS 协议实现安全通信。
    - 此外，还有一些协议依赖于 HTTP，例如 WebSocket、HTTPDNS 等。这些协议相互交织，构成了一个协议网，而 HTTP 则处于中心地位。
- CDN
  - CDN 也是现在互联网中的一项重要基础设施，除了基本的网络加速外，还提供负载均衡、安全防护、边缘计算、跨运营商网络等功能，能够成倍地“放大”源站服务器的服务能力，很多云服务商都把 CDN 作为产品的一部分



## 与HTTP相关的各种协议

- TCP/IP
  - TCP/IP 协议实际上是一系列网络通信协议的统称，其中最核心的两个协议是TCP和IP，其他的还有 UDP、ICMP、ARP 等等，共同构成了一个复杂但有层次的协议栈。
  - HTTP 是一个"传输协议"，但它不关心路由、寻址、数据完整性等传输细节，而要求这些工作都由下层来处理。因为互联网上最流行的是 TCP/IP 协议，而它刚好满足 HTTP 的要求，所以互联网上的 HTTP 协议就运行在了 TCP/IP 上，HTTP 也就可以更准确地称为“HTTP over TCP/IP”。
- DNS
  - 想要使用 TCP/IP 协议来通信仍然要使用 IP 地址，所以需要把域名做一个转换，“映射”到它的真实 IP，这就是所谓的“域名解析”。
  - HTTP 协议中并没有明确要求必须使用 DNS，但实际上为了方便访问互联网上的 Web 服务器，通常都会使用 DNS 来定位或标记主机名，间接地把 DNS 与 HTTP 绑在了一起。
- URI/URL
  - URI（Uniform Resource Identifier），中文名称是 统一资源标识符
  - URL（Uniform Resource Locator）， 统一资源定位符
  - URI 主要有三个基本的部分构成
    - http://nginx.org/en/download.html
    - 协议名：即访问该资源应当使用的协议，在这里是“http”
    - 主机名：即互联网上主机的标记，可以是域名或 IP 地址，在这里是“nginx.org”
    - 路径：即资源在主机上的位置，使用“/”分隔多级目录，在这里是“/en/download.html”
- HTTPS
  - “HTTP over SSL/TLS，也就是运行在 SSL/TLS 协议上的 HTTP。
  -  SSL/TLS是负责加密通信的安全协议，建立在 TCP/IP 之上，所以也是个可靠的传输协议，可以被用作 HTTP 的下层。
  - SSL 的全称是“Secure Socket Layer”，由网景公司发明，当发展到 3.0 时被标准化，改名为 TLS，即“Transport Layer Security”，但由于历史的原因还是有很多人称之为SSL/TLS，或者直接简称为 SSL。
- 代理
  - 代理（Proxy）是 HTTP 协议中请求方和应答方中间的一个环节，作为“中转站”，既可以转发客户端的请求，也可以转发服务器的应答。
  - 功能
    - 负载均衡
    - 内容缓存
    - 安全防护
    - 数据处理







## 常说的“四层”和“七层”到底是什么

- TCP/IP 网络分层模型
  - 第一层：链接层
  - 第二层：网际层
  - 第三层：传输层
  - 第四层：应用层
- OSI 网络分层模型
  - OSI，全称是“开放式系统互联通信参考模型”
    - 第一层：物理层，网络的物理形式，例如电缆、光纤、网卡、集线器等等；
    2. 第二层：数据链路层
    3. 第三层：网络层
    4. 第四层：传输层
    5. 第五层：会话层
    6. 第六层：表示层
    7. 第七层：应用层
  7. TCP/IP 是一个纯软件的栈，没有网络应有的最根基的电缆、网卡等物理设备的位置。而 OSI 则补足了这个缺失，在理论层面上描述网络更加完整。
- 两个分层模型的映射关系
  - 第五、六、七层：统一对应到 TCP/IP 的应用层。
  - 所谓的“四层负载均衡”就是指工作在传输层上，基于 TCP/IP 协议的特性，例如 IP 地址、端口号等实现对后端服务器的负载均衡。
  - 所谓的“七层负载均衡”就是指工作在应用层上，看到的是 HTTP 协议，解析 HTTP 报文里的 URI、主机名、资源类型等数据，再用适当的策略转发给后端服务器。
- TCP/IP 协议栈的工作方式
  
  - HTTP 协议的传输过程就是这样通过协议栈逐层向下，每一层都添加本层的专有数据，层层打包，然后通过下层发送出去。





##  域名

- 域名的解析
  - DNS
    - 访问根域名服务器，它会告诉你“com”顶级域名服务器的地址；
    2. 访问“com”顶级域名服务器，它再告诉你“apple.com”域名服务器的地址；
    3. 最后访问“apple.com”域名服务器，就得到了“www.apple.com”的地址。
  - 在核心 DNS 系统之外，还有两种手段用来减轻域名解析的压力，并且能够更快地获取结果，基本思路就是“缓存”。
    - 其次，操作系统里也会对 DNS 解析结果做缓存，如果你之前访问过“www.apple.com”，那么下一次在浏览器里再输入这个网址的时候就不会再跑到DNS 那里去问了，直接在操作系统里就可以拿到 IP 地址。
    - 另外，操作系统里还有一个特殊的“主机映射”文件/hosts，通常是一个可编辑的文本，如果操作系统在缓存里找不到 DNS记录，就会找这个文件。





## 键入网址再按下回车，后面究竟发生了什么

- 使用 IP 地址访问 Web 服务器

  - 浏览器从地址栏的输入中获得服务器的 IP 地址和端口号；

  2. 浏览器用 TCP 的三次握手与服务器建立连接；
  3. 浏览器向服务器发送拼好的报文；
  4. 服务器收到报文后处理请求，同样拼好报文再发给浏览器；
  5. 浏览器解析报文，渲染输出页面。

- 使用域名访问 Web 服务器

  - Wireshark 抓包过程，你会发现，好像没有什么不同，浏览器上同样显示出了欢迎界面，抓到的包也同样是 11 个：先是三次握手，然后是两次 HTTP 传输
  - 发起域名解析动作，通过访问一系列的域名解析服务器，试图把这个域名翻译成 TCP/IP 协议里的 IP 地址。
  - 在域名解析的过程中会有多级的缓存，浏览器首先看一下自己的缓存里有没有，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 hosts

- 真实的网络世界

  - 假设你要访问的是 Apple 网站，显然你是不知道它的真实 IP 地址的，在浏览器里只能使用
    域名“www.apple.com”访问，那么接下来要做的必然是域名解析。这就要用 DNS 协议开始从操作系统、本地 DNS、根 DNS、顶级 DNS、权威 DNS 的层层解析，当然这中间有缓存，可能不会费太多时间就能拿到结果。
  - CDN，它也会在 DNS 的解析过程中“插上一脚”。DNS 解析可能会给出 CDN 服务器的 IP 地址，这样你拿到的就会是 CDN 服务器而不是目标网站的实际地址。CDN 会缓存网站的大部分资源。
  - 由 PHP、Java 等后台服务动态生成的页面属于“动态资源”，CDN 无法缓存，只能从目标网站获取。于是你发出的 HTTP 请求就要开始在互联网上的“漫长跋涉”，经过无数的路由器、网关、代理，最后到达目的地。
  - 目标网站的服务器对外表现的是一个 IP 地址，但为了能够扛住高并发，在内部也是一套复杂的架构。通常在入口是负载均衡设备，例如四层的 LVS 或者七层的 Nginx，在后面是许多的服务器，构成一个更强更稳定的集群
  - 负载均衡设备会先访问系统里的缓存服务器，通常有 memory 级缓存 Redis 和 disk 级缓存 Varnish，它们的作用与 CDN 类似，不过是工作在内部网络里，把最频繁访问的数据缓存几秒钟或几分钟，减轻后端应用服务器的压力
  - 如果缓存服务器里也没有，那么负载均衡设备就要把请求转发给应用服务器了。这里就是各种开发框架大显神通的地方了，例如 Java 的 Tomcat/Netty/Jetty，Python 的 Django，还有 PHP、Node.js、Golang 等等。它们又会再访问后面的 MySQL、PostgreSQL、MongoDB 等数据库服务，实现用户登录、商品查询、购物下单、扣款支付等业务操作，然后把执行的结果返回给负载均衡设备，同时也可能给缓存服务器里也放一份。
  - 应用服务器的输出到了负载均衡设备这里，请求的处理就算是完成了，就要按照原路再走回去，还是要经过许多的路由器、网关、代理。如果这个资源允许缓存，那么经过 CDN 的时候它也会做缓存，这样下次同样的请求就不会到达源站了。
  - 最后网站的响应数据回到了你的设备，它可能是 HTML、JSON、图片或者其他格式的数据，需要由浏览器解析处理才能显示出来，如果数据里面还有超链接，指向别的资源，那么就又要重走一遍整个流程，直到所有的资源都下载完





