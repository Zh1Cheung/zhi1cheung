---
title: Sharding-JDBC 源码分析 —— 分布式事务（一）之最大努力型 
categories:
- Sharding-JDBC
tags:
- Sharding-JDBC

---

   

[](#1-概述 "1. 概述")1. 概述
=======================

数据库表**分库**后，业务场景下的**单库本地事务**可能变成**跨库分布式事务**。虽然我们可以通过合适的**分库规则**让操作的数据在同库下，继续保证**单库本地事务**，这也是非常推崇的，但不是所有场景下都能适用。如果这些场景对事务的一致性有要求，我们就不得不解决分布式事务的“麻烦”。

**分布式事务**是个很大的话题，我们来看看 Sharding-JDBC 对她的权衡：

> Sharding-JDBC由于性能方面的考量，决定不支持强一致性分布式事务。我们已明确规划线路图，未来会支持最终一致性的柔性事务。

Sharding-JDBC 提供了两种 **柔性事务**：

*   最大努力送达型 BED ：已经实现 
*   事务补偿型 TCC ：计划中



 
[](#2-最大努力送达型 "2. 最大努力送达型")2. 最大努力送达型
======================================

**概念**

> 在分布式数据库的场景下，相信对于该数据库的操作最终一定可以成功，所以通过最大努力反复尝试送达操作。

从概念看，可能不是很直白的理解是什么意思，本文会**最大努力**让你干净理解。

**架构图**

> ![](http://www.iocoder.cn/images/Sharding-JDBC/2017_08_20/01.jpeg)

执行过程有 **四种** 情况：

1.  【红线】执行成功
2.  【棕线】执行失败，同步重试成功
3.  【粉线】执行失败，同步重试失败，异步重试成功
4.  【绿线】执行失败，同步重试失败，异步重试失败，事务日志保留

整体成漏斗倒三角，上一个阶段失败，交给下一个阶段重试：

![](http://www.iocoder.cn/images/Sharding-JDBC/2017_08_20/02.png)

整个过程通过如下 **组件** 完成：

*   柔性事务管理器
*   最大努力送达型柔性事务
*   最大努力送达型事务监听器
*   事务日志存储器
*   最大努力送达型异步作业

下面，我们逐节分享每个组件。

[](#3-柔性事务管理器 "3. 柔性事务管理器")3. 柔性事务管理器
======================================

[](#3-1-概念 "3.1 概念")3.1 概念
--------------------------

柔性事务管理器，SoftTransactionManager 实现，负责对柔性事务配置( SoftTransactionConfiguration ) 、柔性事务( AbstractSoftTransaction )的管理。

[](#3-2-柔性事务配置 "3.2 柔性事务配置")3.2 柔性事务配置
--------------------------------------

调用 `#init()` 初始化柔性管理器：

    // SoftTransactionManager.java  
    /**  
    * 柔性事务配置对象  
    */  
    @Getter  
    private final SoftTransactionConfiguration transactionConfig;   
      
    // SoftTransactionManager.java  
    /**  
    * 初始化事务管理器.  
    */  
    public void init() throws SQLException {  
     // 初始化 最大努力送达型事务监听器  
     EventBusInstance.getInstance().register(new BestEffortsDeliveryListener());  
     // 初始化 事务日志数据库
