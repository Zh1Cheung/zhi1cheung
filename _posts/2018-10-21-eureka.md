---
title: Eureka 源码解析 —— 网络通信 


categories:
- Eureka 
- SpringBoot
tags:
- Eureka

---
   
 
[](#1-概述 "1. 概述")1\. 概述
=======================

本文主要分享 **Eureka 的网络通信部分**。在不考虑 Eureka 2.x 的兼容的情况下，Eureka 1.x 主要两部分的网络通信：

*   Eureka-Client 请求 Eureka-Server 的网络通信
*   Eureka-Server 集群内，Eureka-Server 请求 **其它的Eureka-Server** 的网络通信

本文涉及类在 `com.netflix.discovery.shared.transport` 包下，涉及到主体类的类图如下( [打开大图](http://www.iocoder.cn/images/Eureka/2018_07_31/01.png) )：

![](http://www.iocoder.cn/images/Eureka/2018_07_31/01.png)

*   粉色部分 —— EurekaJerseyClient ，对基于 Jersey Server 的 Eureka-Server 的 Jersey 客户端封装。
*   绿色部分 —— EurekaHttpClient ，Eureka-Server HTTP 访问客户端，定义了具体的 Eureka-Server API 调用方法。如果把 DiscoveryClient 类比成 Service ，那么 EurekaHttpClient 可以类比城 Dao 。
*   综色部分 —— EurekaHttpClient 实现类，**真正**实现了具体的 Eureka-Server API 调用方法。
*   红色部分 —— EurekaHttpClient 委托类，提供了**会话、重试、重定向、监控指标收集**等特性。
*   黄色部分 —— EurekaHttpClientFactory，用于创建 EurekaHttpClient 。

类图看起来很复杂，整体调用关系如下( [打开大图](http://www.iocoder.cn/images/Eureka/2018_07_31/02.png) )：
 
![](http://www.iocoder.cn/images/Eureka/2018_07_31/02.png)



[](#2-EurekaHttpClient "2. EurekaHttpClient")2\. EurekaHttpClient
=================================================================

`com.netflix.discovery.shared.transport.jersey.EurekaJerseyClient` ，EurekaHttpClient **接口**。接口代码如下：

    public interface EurekaJerseyClient {  
      
     ApacheHttpClient4 getClient();  
        
     void destroyResources();  
    }  

*   `com.sun.jersey.client.apache4.ApacheHttpClient4` ，基于 Apache HttpClient4 实现的 Jersey Client 。

[](#2-1-EurekaJerseyClientImpl "2.1 EurekaJerseyClientImpl")2.1 EurekaJerseyClientImpl
--------------------------------------------------------------------------------------

`com.netflix.discovery.shared.transport.jersey.EurekaJerseyClientImpl` ，EurekaHttpClient **实现类**。实现代码如下：

    public class EurekaJerseyClientImpl implements EurekaJerseyClient {  
      
     /**  
     * 基于 Apache HttpClient4 实现的 Jersey Client  
     */  
     private final ApacheHttpClient4 apacheHttpClient;  
     /**  
     * Apache HttpClient 空闲连接清理器  
     */  
     private final ApacheHttpClientConnectionCleaner apacheHttpClientConnectionCleaner;  
      
     /**  
     * Jersey Client 配置  
     */  
     ClientConfig jerseyClientConfig;  
      
     public EurekaJerseyClientImpl(int connectionTimeout, int readTimeout, final int connectionIdleTimeout,  
     ClientConfig clientConfig) {  
     try {  
     jerseyClientConfig = clientConfig;  
     // 创建  ApacheHttpClient  
     apacheHttpClient = ApacheHttpClient4.create(jerseyClientConfig);  
      
     // 设置 连接参数  
     HttpParams params = apacheHttpClient.getClientHandler().getHttpClient().getParams();  
     HttpConnectionParams.setConnectionTimeout(params, connectionTimeout);  
     HttpConnectionParams.setSoTimeout(params, readTimeout);  
      
     // 创建 ApacheHttpClientConnectionCleaner  
     this.apacheHttpClientConnectionCleaner = new ApacheHttpClientConnectionCleaner(apacheHttpClient, connectionIdleTimeout);  
     } catch (Throwable e) {  
     throw new RuntimeException("Cannot create Jersey client", e);  
     }  
     }  
      
     @Override  
     public ApacheHttpClient4 getClient() {  
     return apacheHttpClient;  
     }  
      
     @Override  
     public void destroyResources() {  
     apacheHttpClientConnectionCleaner.shutdown();  
     apacheHttpClient.destroy();  
     }  
    }  

*   `com.netflix.discovery.shared.transport.jersey.ApacheHttpClientConnectionCleaner` ，Apache HttpClient 空闲连接清理器，负责**周期性**关闭处于 `half-close` 状态的空闲连接。点击 [链接](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/ApacheHttpClientConnectionCleaner.java) 查看带中文注释的 ApacheHttpClientConnectionCleaner。推荐阅读：[《HttpClient容易忽视的细节——连接关闭》](http://seanhe.iteye.com/blog/234759) 。

[](#2-2-EurekaJerseyClientBuilder "2.2 EurekaJerseyClientBuilder")2.2 EurekaJerseyClientBuilder
-----------------------------------------------------------------------------------------------

EurekaJerseyClientBuilder ，EurekaJerseyClientImpl **内部类**，用于创建 EurekaJerseyClientImpl 。

调用 `#build()` 方法，创建 EurekaJerseyClientImpl ，实现代码如下：

    // EurekaJerseyClientBuilder.java  
    public EurekaJerseyClient build() {  
     MyDefaultApacheHttpClient4Config config = new MyDefaultApacheHttpClient4Config();  
     try {  
     return new EurekaJerseyClientImpl(connectionTimeout, readTimeout, connectionIdleTimeout, config);  
     } catch (Throwable e) {  
     throw new RuntimeException("Cannot create Jersey client ", e);  
     }  
    }  

*   MyDefaultApacheHttpClient4Config ，继承自 `com.sun.jersey.client.apache4.config.DefaultApacheHttpClient4Config` ，实现**自定义配置**。点击 [链接](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/EurekaJerseyClientImpl.java#L199) 查看带中文注释的 MyDefaultApacheHttpClient4Config。例如 ：
    *   自定义的**请求、响应的编解码器** `com.netflix.discovery.provider.DiscoveryJerseyProvider` 。
    *   禁用**重定向**，使用 RedirectingEurekaHttpClient 实现该特性。
    *   自定义 UserAgent 。
    *   自定义 Http Proxy 。
    *   SSL 功能的增强。ApacheHttpClient4 使用的是 Apache HttpClient 4.1.1 版本，`com.netflix.discovery.shared.transport.jersey.SSLSocketFactoryAdapter` 将 Apache HttpClient 4.3.4 对 SSL 功能的增强适配到老版本 API 。点击 [链接](https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/SSLSocketFactoryAdapter.java) 查看带中文注释的 SSLSocketFactoryAdapter。

[](#3-EurekaHttpClient "3. EurekaHttpClient")3\. EurekaHttpClient
=================================================================

`com.netflix.discovery.shared.transport.EurekaHttpClient` ，Eureka-Server HTTP 访问客户端，定义了具体的 Eureka-Server API 调用方法 。点击 [链接](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/EurekaHttpClient.java) 查看带中文注释的 EurekaHttpClient。

[](#3-1-EurekaHttpResponse "3.1 EurekaHttpResponse")3.1 EurekaHttpResponse
--------------------------------------------------------------------------

`com.netflix.discovery.shared.transport.EurekaHttpResponse` ，请求响应对象，实现代码如下：

    public class EurekaHttpResponse<T\> {  
      
     /**  
     * 返回状态码  
     */  
     private final int statusCode;  
     /**  
     * 返回对象( Entity )  
     */  
     private final T entity;  
     /**  
     * 返回 header  
     */  
     private final Map<String, String> headers;  
     /**  
     * 重定向地址  
     */  
     private final URI location;  
        
     // ... 省略 setting / getting 和 Builder  
    }  

[](#3-2-TransportClientFactory "3.2 TransportClientFactory")3.2 TransportClientFactory
--------------------------------------------------------------------------------------

`com.netflix.discovery.shared.transport.TransportClientFactory` ，创建 EurekaHttpClient 的工厂**接口**。接口代码如下：

    public interface TransportClientFactory {  
      
     /**  
     * 创建 EurekaHttpClient  
     *  
     * @param serviceUrl Eureka-Server 地址  
     * @return EurekaHttpClient  
     */  
     EurekaHttpClient newClient(EurekaEndpoint serviceUrl);  
      
     /**  
     * 关闭工厂  
     */  
     void shutdown();  
      
    }  

**大多数 
