---
title: Linux-综合性能分析
categories:
- Linux
tags:
- Linux


---









## **综合：分析性能问题的一般步骤**

- **系统资源瓶颈**
  - 使用率、饱和度以及错误数这三类指标来衡量。系统的资源，可以分为硬件资源和软件资源两 类。
    - 如 CPU、内存、磁盘和文件系统以及网络等，都是最常见的硬件资源。 
    - 而文件描述符数、连接跟踪数、套接字缓冲区大小等，则是典型的软件资源。
- **CPU** **性能分析**
  - ![img](https://img2018.cnblogs.com/blog/1075436/201909/1075436-20190925163759359-2129947612.png)
  - 比如说，当你收到系统的用户 CPU 使用率过高告警时，从监控系统中直接查询到，导致 CPU 使用率过高的进程；然后再登录到进程所在的 Linux 服务器中，分析该进程的行为。 
  - 你可以使用 strace，查看进程的系统调用汇总；也可以使用 perf 等工具，找出进程的热点 函数；甚至还可以使用动态追踪的方法，来观察进程的当前执行过程，直到确定瓶颈的根 源。
- **内存性能分析**
  - ![img](https://img2018.cnblogs.com/blog/1075436/201909/1075436-20190925164214302-575822803.png)
  - 比如说，当你收到内存不足的告警时，首先可以从监控系统中。找出占用内存最多的几个进 程。然后，再根据这些进程的内存占用历史，观察是否存在内存泄漏问题。
  - 确定出最可疑的 进程后，再登录到进程所在的 Linux 服务器中，分析该进程的内存空间或者内存分配，最 后弄清楚进程为什么会占用大量内存
- **磁盘和文件系统** **I/O** **性能分析**
  - ![img](https://img2018.cnblogs.com/blog/1075436/201909/1075436-20190925164238972-714799998.png)
  - 当你使用 iostat ，发现磁盘 I/O 存在性能瓶颈（比如 I/O 使用率过 高、响应时间过长或者等待队列长度突然增大等）后，可以再通过 pidstat、 vmstat 等， 确认 I/O 的来源。接着，再根据来源的不同，进一步分析文件系统和磁盘的使用率、缓存 以及进程的 I/O 等，从而揪出 I/O 问题的真凶
  - 比如说，当你发现某块磁盘的 I/O 使用率为 100% 时，首先可以从监控系统中，找出 I/O 最多的进程。然后，再登录到进程所在的 Linux 服务器中，借助 strace、lsof、perf 等工具，分析该进程的 I/O 行为。最后，再结合应用程序的原理，找出大量 I/O 的原因。 
- **网络性能分析**
  - 最后的网络性能，其实包含两类资源，即网络接口和内核资源
  - 而要分析网络的性能，自然也是要从这几个协议层入手，通过使用率、饱和度以及错误数这 几类性能指标，观察是否存在性能问题。比如 ： 
    - 在链路层，可以从网络接口的吞吐量、丢包、错误以及软中断和网络功能卸载等角度分 析； 
    - 在网络层，可以从路由、分片、叠加网络等角度进行分析； 
    - 在传输层，可以从 TCP、UDP 的协议原理出发，从连接数、吞吐量、延迟、重传等角度 进行分析；在应用层，可以从应用层协议（如 HTTP 和 DNS）、请求数（QPS）、套接字缓存等角 度进行分析。 
  - 比如，当你收到网络不通的告警时，就可以从监控系统中，查找各个协议层的丢包指标，确 认丢包所在的协议层。然后，从监控系统的数据中，确认网络带宽、缓冲区、连接跟踪数等 软硬件，是否存在性能瓶颈。最后，再登录到发生问题的 Linux 服务器中，借助 netstat、 tcpdump、bcc 等工具，分析网络的收发数据，并且结合内核中的网络选项以及 TCP 等网 络协议的原理，找出问题的来源
- **应用程序瓶颈**
  - 除了以上这些来自网络资源的瓶颈外，还有很多瓶颈，其实直接来自应用程序。比如，最典 型的应用程序性能问题，就是吞吐量（并发请求数）下降、错误率升高以及响应时间增大。 
  - 不过，在我看来，这些应用程序性能问题虽然各种各样，但就其本质来源，实际上只有三 种，也就是资源瓶颈、依赖服务瓶颈以及应用自身的瓶颈。 
    - 第一种**资源瓶颈**，其实还是指刚才提到的 CPU、内存、磁盘和文件系统 I/O、网络以及内 核资源等各类软硬件资源出现了瓶颈，从而导致应用程序的运行受限。对于这种情况，我们 就可以用前面系统资源瓶颈模块提到的各种方法来分析。 
    - 第二种**依赖服务的瓶颈**，也就是诸如数据库、分布式缓存、中间件等应用程序，直接或者间 接调用的服务出现了性能问题，从而导致应用程序的响应变慢，或者错误率升高。这说白了 就是跨应用的性能问题，使用全链路跟踪系统，就可以帮你快速定位这类问题的根源。 
    - 最后一种，**应用程序自身的性能问题**，包括了多线程处理不当、死锁、业务算法的复杂度过 高等等。对于这类问题，在我们前面讲过的应用程序指标监控以及日志监控中，观察关键环 节的耗时和内部执行过程中的错误，就可以帮你缩小问题的范围。 
  - 不过，由于这是应用程序内部的状态，外部通常不能直接获取详细的性能数据，所以就需要 应用程序在设计和开发时，就提供出这些指标，以便监控系统可以了解应用程序的内部运行状态。 
  - 如果这些手段过后还是无法找出瓶颈，你还可以用系统资源模块提到的各类进程分析工具， 来进行分析定位。比如： 
    - 你可以用 strace，观察系统调用； 
    - 使用 perf 和火焰图，分析热点函数； 
    - 甚至使用动态追踪技术，来分析进程的执行状态。
  - 当然，系统资源和应用程序本来就是相互影响、相辅相成的一个整体。实际上，很多资源瓶 颈，也是应用程序自身运行导致的。比如，进程的内存泄漏，会导致系统内存不足；进程过 多的 I/O 请求，会拖慢整个系统的 I/O 请求等。



## **综合：优化性能问题的一般方法**

- 我们可以从系统资源瓶颈和应用程序瓶颈，这两个角度来分析性能问题的根源

  - 从系统资源瓶颈的角度来说，USE 法是最为有效的方法，即从使用率、饱和度以及错误数 这三个方面，来分析 CPU、内存、磁盘和文件系统 I/O、网络以及内核资源限制等各类软硬件资源。
  - 从应用程序瓶颈的角度来说，可以把性能问题的来源，分为资源瓶颈、依赖服务瓶颈以及应 用自身的瓶颈这三类。 
  - 资源瓶颈的分析思路，跟系统资源瓶颈是一样的。 
  - 依赖服务的瓶颈，可以使用全链路跟踪系统，进行快速定位。 
  - 而应用自身的问题，则可以通过系统调用、热点函数，或者应用自身的指标和日志等，进 行分析定位。 

- **CPU** **优化**

  - CPU 性能优化的核心，在于排除所有不必要的工作、充分利用 CPU 缓存并减少进程调度对性能的*影响
  - 最典型 的三种优化方法。
  - 第一种，把进程绑定到一个或者多个 CPU 上，充分利用 CPU 缓存的本地性，并减少进 程间的相互影响。 
  - 第二种，为中断处理程序开启多 CPU 负载均衡，以便在发生大量中断时，可以充分利用多 CPU 的优势分摊负载。 
  - 第三种，使用 Cgroups 等方法，为进程设置资源限制，避免个别进程消耗过多的 CPU。 同时，为核心应用程序设置更高的优先级，减少低优先级任务的影响。 

- **内存优化**

  - 内存问题，比如可用内存不足、内存泄漏、 Swap 过多、缺页异常过多以及缓存过多等等。所以，说白了，内存性能的优化，也就是要 解决这些内存使用的问题。
  - 你可以通过以下几种方法
    - 第一种，除非有必要，Swap 应该禁止掉。这样就可以避免 Swap 的额外 I/O ，带来内 存访问变慢的问题。 
    - 第二种，使用 Cgroups 等方法，为进程设置内存限制。这样就可以避免个别进程消耗过多内存，而影响了其他进程。对于核心应用，还应该降低 oom_score，避免被 OOM 杀 死。 
    - 第三种，使用大页、内存池等方法，减少内存的动态分配，从而减少缺页异常。

- **磁盘和文件系统** **I/O** **优化**

  - 三种最典型的方 法。
    - 第一种，也是最简单的方法，通过 SSD 替代 HDD、或者使用 RAID 等方法，提升 I/O性能。 
    - 第二种，针对磁盘和应用程序 I/O 模式的特征，选择最适合的 I/O 调度算法。比如， SSD 和虚拟机中的磁盘，通常用的是 noop 调度算法；而数据库应用，更推荐使用deadline 算法。 
    - 第三，优化文件系统和磁盘的缓存、缓冲区，比如优化脏页的刷新频率、脏页限额，以及 内核回收目录项缓存和索引节点缓存的倾向等等。
  - 除此之外，使用不同磁盘隔离不同应用的数据、优化文件系统的配置选项、优化磁盘预读、 增大磁盘队列长度等，也都是常用的优化思路。

- **网络优化**

  - 针对每个协议层的工作原理 进行优化。这里，我同样强调一下，最典型的几种网络优化方法。
    - 首先，从内核资源和网络协议的角度来说，我们可以对内核选项进行优化，比如： 
      - 你可以增大套接字缓冲区、连接跟踪表、最大半连接数、最大文件描述符数、本地端口范 围等内核资源配额； 
      - 也可以减少 TIMEOUT 超时时间、SYN+ACK 重传数、Keepalive 探测时间等异常处理 参数； 
      - 还可以开启端口复用、反向地址校验，并调整 MTU 大小等降低内核的负担。 
    - 其次，从网络接口的角度来说，我们可以考虑对网络接口的功能进行优化，比如： 
      - 你可以将原来 CPU 上执行的工作，卸载到网卡中执行，即开启网卡的 GRO、GSO、 RSS、VXLAN 等卸载功能； 
      - 也可以开启网络接口的多队列功能，这样，每个队列就可以用不同的中断号，调度到不同 CPU 上执行； 
      - 还可以增大网络接口的缓冲区大小以及队列长度等，提升网络传输的吞吐量。

- **应用程序优化**

  - 第一个例子，是系统 CPU 使用率（sys%）过高的问题。有时候出现问题，虽然表面现象是系统 CPU 使用率过高，但待你分析过后，很可能会发现，应用程序的不合理系统调用才是罪魁祸首。这种情况下，优化应用程序内部系统调用的逻辑，显然要比优化内核要简单也有 用得多。 
  - 再比如说，数据库的 CPU 使用率高、I/O 响应慢，也是最常见的一种性能问题。这种问 题，一般来说，并不是因为数据库本身性能不好，而是应用程序不合理的表结构或者 SQL查询语句导致的。这时候，优化应用程序中数据库表结构的逻辑或者 SQL 语句，显然要比优化数据库本身，能带来更大的收益。
  - 所以，在观察性能指标时，你应该先查看**应用程序的响应时间、吞吐量以及错误率**等指标，因为它们才是性能优化要解决的终极问题。以终为始，从这些角度出发，你一定能想到很多优化方法，而我比较推荐下面几种方法。
    - 第一，从 CPU 使用的角度来说，简化代码、优化算法、异步处理以及编译器优化等，都 是常用的降低 CPU 使用率的方法，这样可以利用有限的 CPU 处理更多的请求。 
    - 第二，从数据访问的角度来说，使用缓存、写时复制、增加 I/O 尺寸等，都是常用的减 少磁盘 I/O 的方法，这样可以获得更快的数据处理速度。
    - 第三，从内存管理的角度来说，使用大页、内存池等方法，可以预先分配内存，减少内存的动态分配，从而更好地内存访问性能。 
    - 第四，从网络的角度来说，使用 I/O 多路复用、长连接代替短连接、DNS 缓存等方法，可以优化网络 I/O 并减少网络请求数，从而减少网络延时带来的性能问题。 
    - 第五，从进程的工作模型来说，异步处理、多线程或多进程等，可以充分利用每一个 CPU 的处理能力，从而提高应用程序的吞吐能力。 
    - 除此之外，你还可以使用消息队列、CDN、负载均衡等各种方法，来优化应用程序的架构，将原来单机要承担的任务，调度到多台服务器中并行处理。这样也往往能获得更好的整体性能

  

  

